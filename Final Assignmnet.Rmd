---
title: "Final Assignment Analysis: A multi-decade time series of kelp forest community structure at San Nicolas Islands, California"
author: "Elizabeth Martin, Marjorie Mednikova, Riplee Mercer"
date: "December 6, 2022"
output: pdf_document
---

## Introduction



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(dplyr)
```


## Pulling in Data

```{r data}
kelp <-read.csv("final_rawdata.csv",stringsAsFactors = TRUE)
unique(kelp$GENUS_SPECIES)
```


## Data Cleaning

```{r data cleaning}

## Removing Columns
kelp_cleaned <- kelp %>% 
                  select(-SAMPLE_DESC,
                         -BIOMAS)


## Renaming Columns
kelp_cleaned <- kelp_cleaned %>% 
                        rename(Abundance = ABUNDANCE, 
                               Species = `GENUS_SPECIES`,
                               Plot = PLOT,
                               Latitude = LATITUDE,
                               Longitude = LONGITUDE,
                               Day = DAY, 
                               Month = MONTH,
                               Year = YEAR) 

## Adding Date Column
kelp_cleaned['Date'] <- NA
kelp_cleaned$Date<-as.Date(with(kelp_cleaned,paste(Year,Month,Day,sep="-")),"%Y-%m-%d")


## Adding Phylum Column
phylum <- read.csv("phylum.csv", stringsAsFactors = TRUE)
kelp_cleaned <- left_join(kelp_cleaned, phylum, by="Species")



## Organizing Columns
kelp_cleaned = select(kelp_cleaned, Abundance, Phylum, Species, Plot, Latitude, Longitude, Date, Year, Month, Day)


head(kelp_cleaned)
```


## Graphs

(1) Seasonal patterns, by phylum
(2) Echinoderms over time (before/after sea otters and El Nino events)
(3) Echinoderms by decade
(4) Sea urchins over time (before/after sea otters and El Nino events)
(5) Algal abundance over time (before/after sea otters and El Nino events)

## Seasonal patterns, by phylum

```{r Seasons}

# Phylum abundance by season

# Create function using if-else statement to determine season:

season <- function(Month){
  if(Month<=3 | Month>11){return("Winter")
    }else if (Month>=4 & Month<=6){return("Spring")
    }else if(Month>6 & Month<=9){return("Summer")
    }else {return("Fall")}}

kelp_cleaned$Season <- vector("character", length=nrow(kelp_cleaned))
for (i in 1:nrow(kelp_cleaned)){
  kelp_cleaned$Season[i]<- season(kelp_cleaned$Month[i])}

# Average abundance by phylum and season: 

phylum_seasons <- kelp_cleaned %>%
  select(Abundance, Year, Date, Species, Phylum, Season) %>% 
  group_by(Season, Phylum) %>%
  summarize(Mean_Abundance = mean(Abundance), SD = sd(Abundance))
  
# Plotting average seasonal abundance by phylum, with error bars showing standard deviation:

ggplot(data=phylum_seasons, aes(x=Season, y=Mean_Abundance, 
                          by=Phylum)) + 
  geom_col(aes(fill=Phylum)) + 
  labs(x="Year", y="Mean Seasonal Abundance") +  
  facet_wrap(~Phylum, scales="free") + 
  geom_errorbar(aes(ymin=Mean_Abundance-SD, ymax=Mean_Abundance+SD),
                width=.1,color="black")
```

## Abundance of Echinoderms over time, with lines for otter reintroduction and El Nino ##

```{r Echinodermata before vs after sea otters}
## Subset by phylum
echinodermata_year <- kelp_cleaned %>% 
  select(Abundance, Phylum, Species, Year, Date) %>% 
  filter(Phylum == "Echinodermata") %>% 
  group_by(Year, Phylum) %>% 
  summarize(Mean_Abundance = mean(Abundance))

## Plotting
ggplot(data= echinodermata_year,
       aes(x= Year, y= Mean_Abundance,
           color= Phylum, by= Phylum)) +
  geom_point() + geom_line() +
  geom_vline(xintercept= 1987, color= 'red') + 
  geom_vline(xintercept= 1983, color= 'blue') + 
  geom_vline(xintercept= 1998, color= 'blue') +
  labs(x= "Year", y= "Mean Annual Abundance")
```
# Abundance of Echinoderms over time, grouped by decade ##

```{r Decades}

#decade column

decades <- function(Year){
  if(Year>=1980 & Year <=1989){return("1980s")
  }else if (Year>=1990 & Year <=1999){return("1990s")
  }else if (Year>=2000 & Year <=2009){return("2000s")
  }else {return("2010s")}}
kelp_cleaned$Decades <- vector("character", length = nrow(kelp_cleaned))
for (i in 1:nrow(kelp_cleaned)){
  kelp_cleaned$Decades[i]<-decades(kelp_cleaned$Year[i])
}

#Abundance of Echinoderms in each decade
echinoderm_decades <- kelp_cleaned %>% 
  select(Abundance, Phylum, Species, Year, Decades) %>% 
  filter(Phylum=="Echinodermata") 
  
##Plotting
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
geom_point() + geom_line()

##facet species
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line()+
  facet_wrap(~Species)
  
##re-introduction of sea otters
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line()+
geom_vline(xintercept= 1987, color= 'black') 

##facet species
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line()+
  geom_vline(xintercept= 1987, color= 'black') +
facet_wrap(~Species)

##El Nino Events 
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line() +
geom_vline(xintercept= 1983, color= 'black') + 
  geom_vline(xintercept= 1998, color= 'black')
  
##facet species
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line() +
  geom_vline(xintercept= 1983, color= 'black') + 
  geom_vline(xintercept= 1998, color= 'black')+
facet_wrap(~Species)

##El Nino events and sea otters 
ggplot(data=echinoderm_decades,
       aes(x= Year, y=Abundance, color= Decades, by=Decades)) +
  geom_point() + geom_line() +
  geom_vline(xintercept= 1983, color= 'black') + 
  geom_vline(xintercept= 1998, color= 'black')+
  geom_vline(xintercept= 1987, color= 'black')

```

# Abundance of sea urchin species specifically
```{r urchins}
urchin_species <- kelp_cleaned %>%
select(Abundance, Year, Date, Species) %>% 
  filter(Species == "Strongylocentrotus franciscanus" | 
           Species =="Strongylocentrotus purpuratus") %>% 
  group_by(Year, Species) %>%
  summarize(Mean_Abundance = mean(Abundance))

ggplot(data=urchin_species,aes(x=Year, y=Mean_Abundance,
                                color=Species, by=Species)) +
  geom_line(aes(color = Species)) +
  geom_vline(xintercept= 1987, color= 'red')+
  geom_vline(xintercept= 1983, color= 'blue') + 
  geom_vline(xintercept= 1998, color= 'blue') +
  labs(x= "Year", y= "Mean Annual Abundance")
```

## Mean abundance of kelp (by phyla) over time, with lines for otter introduction and El Nino #

```{r kelp}
# Subsetting by algae: 
algae_year <- kelp_cleaned %>%
  select(Abundance, Year, Date, Species, Phylum) %>% 
  filter(Phylum == "Rhodophyta" | Phylum == "Chlorophyta" |
           Phylum == "Phaeophyta") %>% 
  group_by(Year, Phylum) %>%
  summarize(Mean_Abundance = mean(Abundance))


ggplot(data=algae_year, aes(x=Year, y=Mean_Abundance, 
                            color=Phylum, by=Phylum)) + 
  geom_point() + geom_line() +
  geom_vline(xintercept= 1987, color= 'red') + 
  geom_vline(xintercept= 1983, color= 'blue') + 
  geom_vline(xintercept= 1998, color= 'blue') +
  scale_color_manual(values = c("mediumseagreen", "chocolate4", 
                                "red3")) +
  labs(x="Year", y="Mean Annual Abundance")
```
